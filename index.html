<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1" />
<title>Squat 90Â° â€” Skeleton + Angles + Reps</title>

<!-- (optional but helpful) CSP that allows jsDelivr assets -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'unsafe-inline';
  style-src  'self' 'unsafe-inline';
  img-src    'self' data:;
  connect-src 'self' https://cdn.jsdelivr.net;
  frame-src  'self';
  object-src 'none';
  base-uri   'self';
">

<style>
  html, body { margin:0; height:100%; background:#000; overflow:hidden; touch-action:none; -webkit-user-select:none; user-select:none; }
  #wrap { position:fixed; inset:0; }
  video, canvas { position:absolute; inset:0; width:100vw; height:100vh; object-fit:cover; }
  canvas { image-rendering: optimizeSpeed; }
  #flip, #mute {
    position:absolute; top:14px; width:44px; height:44px; border-radius:50%;
    background:rgba(0,0,0,.45); border:2px solid rgba(255,255,255,.85); color:#fff;
    display:flex; align-items:center; justify-content:center; font:600 14px system-ui,-apple-system,Segoe UI,Roboto;
    z-index:5; cursor:pointer; user-select:none;
  }
  #flip { right:14px; }
  #mute { right:66px; }
  #hud {
    position:absolute; left:16px; bottom:16px; z-index:5; color:#fff;
    font:600 28px system-ui,-apple-system,Segoe UI,Roboto; text-shadow:0 1px 2px rgba(0,0,0,.6);
  }
  #hud small { display:block; font:500 14px system-ui,-apple-system,Segoe UI,Roboto; opacity:.9; }
</style>
</head>
<body>
  <div id="wrap">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="overlay"></canvas>
    <div id="flip" title="Flip (front/back)" aria-label="Flip Camera">â†º</div>
    <div id="mute" title="Beep on/off" aria-label="Toggle Beep">ðŸ”ˆ</div>
    <div id="hud"><span id="reps">0</span><small>reps</small></div>
  </div>

  <!-- MediaPipe classic (Pose + drawing utils) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675469404/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675469404/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>

<script>
(async () => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  const flipBtn = document.getElementById('flip');
  const muteBtn = document.getElementById('mute');
  const repsEl = document.getElementById('reps');

  // layout
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', resize); resize();

  // camera + flip
  let currentFacing = 'environment', currentStream = null;
  async function stopStream(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } }
  async function chooseDeviceIdForFacing(facing){
    const devs = await navigator.mediaDevices.enumerateDevices().catch(()=>[]);
    const cams = devs.filter(d=>d.kind==='videoinput');
    if(!cams.length) return null;
    const re = facing==='environment' ? /(back|rear|environment)/i : /(front|user|face)/i;
    const m = cams.find(c=>re.test(c.label));
    if (m) return m.deviceId;
    return facing==='environment' ? (cams[cams.length-1]?.deviceId ?? cams[0]?.deviceId)
                                  : (cams[0]?.deviceId ?? null);
  }
  async function initCamera(facing='environment'){
    currentFacing = facing;
    await stopStream();
    let stream;
    try{
      const id = await chooseDeviceIdForFacing(facing);
      const constraint = id ? { deviceId:{ exact:id } } : { facingMode:{ ideal:facing } };
      stream = await navigator.mediaDevices.getUserMedia({
        video: Object.assign(constraint, { width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30} }),
        audio:false
      });
    }catch(e){
      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    }
    currentStream = stream; video.srcObject = stream;
    await video.play().catch(()=>{});
    // mirror preview for front camera
    video.style.transform = (currentFacing==='user') ? 'scaleX(-1)' : 'none';
  }
  async function flipCamera(){ await initCamera(currentFacing==='environment' ? 'user' : 'environment'); }
  flipBtn.onclick = flipCamera;
  document.addEventListener('keydown', e => { if(e.key.toLowerCase()==='f') flipCamera(); });
  document.addEventListener('touchstart', ()=>{ if(video.paused) video.play().catch(()=>{}); }, {passive:true});
  await initCamera('environment');

  // beep (WebAudio)
  let audioCtx = null, beepOn = true;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(){
    if(!beepOn) return;
    ensureAudio();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=880; g.gain.value=0.001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime+0.15);
    o.stop(audioCtx.currentTime+0.16);
  }
  muteBtn.onclick = () => { beepOn = !beepOn; muteBtn.textContent = beepOn ? 'ðŸ”ˆ' : 'ðŸ”‡'; };

  // MediaPipe Pose â€” NOTE: correct constructor & connections constant
  const pose = new Pose({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${f}`
  });
  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  let last = null, noLandmarkFrames = 0;
  pose.onResults(r => { last = r; });

  // helpers
  function mirrorIfFront(lm){
    if (currentFacing !== 'user') return lm;
    return lm.map(p => ({...p, x: 1 - p.x}));
  }
  function toPx(p,W,H){ return { x:p.x*W, y:p.y*H }; }
  function angleAt(B,A,C){
    const bax=A.x-B.x, bay=A.y-B.y; const bcx=C.x-B.x, bcy=C.y-B.y;
    const dot=bax*bcx+bay*bcy, ab=Math.hypot(bax,bay), cb=Math.hypot(bcx,bcy);
    if(!ab||!cb) return NaN;
    let cos=dot/(ab*cb); cos=Math.max(-1,Math.min(1,cos));
    return Math.acos(cos)*180/Math.PI;
  }
  function sidePick(lm){
    const L=[23,25,27,31], R=[24,26,28,32];
    const sum = ids => ids.map(i=>lm[i]?.visibility??0).reduce((a,b)=>a+b,0);
    return sum(L) >= sum(R) ? 'L' : 'R';
  }
  function legLm(lm, side){
    return side==='L'
      ? {hip:lm[23], knee:lm[25], ankle:lm[27], heel:lm[29], foot:lm[31], kneeOther:lm[26]}
      : {hip:lm[24], knee:lm[26], ankle:lm[28], heel:lm[30], foot:lm[32], kneeOther:lm[25]};
  }

  // smoothing
  const kBuf=[]; const aBuf=[]; const BUF=8;
  const smooth = (buf,v)=>{ buf.push(v); if(buf.length>BUF) buf.shift(); return buf.reduce((x,y)=>x+y,0)/buf.length; };

  // rep counter
  let reps=0, phase='up', at90Frames=0;
  const K_STAND=160, K_90_MIN=86, K_90_MAX=94;
  function updateReps(kneeAngle){
    if (kneeAngle>=K_90_MIN && kneeAngle<=K_90_MAX) {
      if (phase!=='at90') at90Frames=0;
      phase='at90'; at90Frames++;
    } else if (kneeAngle < K_90_MIN) {
      phase='down'; at90Frames=0;
    } else if (kneeAngle > K_90_MAX) {
      if ((phase==='at90' || phase==='down') && at90Frames>=5 && kneeAngle > (K_STAND-5)) {
        reps++; repsEl.textContent = reps; beep();
      }
      phase='up'; at90Frames=0;
    }
  }

  // UI badges
  function badge(text, x, y){
    ctx.font='bold 20px system-ui,-apple-system,Segoe UI,Roboto';
    const w = ctx.measureText(text).width + 16;
    ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(x, y-24, w, 28);
    ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=2; ctx.strokeRect(x, y-24, w, 28);
    ctx.fillStyle='#fff'; ctx.fillText(text, x+8, y-5);
  }

  async function tick(){
    if (video.readyState >= 2) await pose.send({ image: video });

    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    if (last?.poseLandmarks) {
      noLandmarkFrames = 0;
      const lm = mirrorIfFront(last.poseLandmarks);

      // full skeleton (correct constant)
      drawConnectors(ctx, lm, POSE_CONNECTIONS, { color:'#00FF7F', lineWidth:3 });
      drawLandmarks(ctx, lm, { color:'#FFFFFF', lineWidth:1, radius:2 });

      // highlight 1 leg + compute angles
      const side = sidePick(lm);
      const L = legLm(lm, side);
      const pHip = toPx(L.hip,W,H), pKnee = toPx(L.knee,W,H), pAnk = toPx(L.ankle,W,H);
      const pFoot = L.foot ? toPx(L.foot,W,H) : pAnk;
      const pKneeO = L.kneeOther ? toPx(L.kneeOther,W,H) : pKnee;

      ctx.lineWidth=6; ctx.strokeStyle='rgba(0,255,180,.95)';
      ctx.beginPath(); ctx.moveTo(pHip.x,pHip.y); ctx.lineTo(pKnee.x,pKnee.y); ctx.lineTo(pAnk.x,pAnk.y); ctx.lineTo(pFoot.x,pFoot.y); ctx.stroke();
      [pHip,pKnee,pAnk,pFoot].forEach(pt=>{ ctx.beginPath(); ctx.arc(pt.x,pt.y,6,0,Math.PI*2); ctx.fillStyle='#00ffc8'; ctx.fill(); });

      let kneeAngle = angleAt(L.knee, L.hip, L.ankle);
      let ankleRef = (L.foot ?? L.heel ?? L.ankle);
      let ankleAngle = angleAt(L.ankle, L.knee, ankleRef);
      kneeAngle = smooth(kBuf, kneeAngle);
      ankleAngle = smooth(aBuf, ankleAngle);

      // â€œchair lineâ€ at average knee height
      const chairY = (pKnee.y + pKneeO.y)/2;
      ctx.setLineDash([10,10]); ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,.7)';
      ctx.beginPath(); ctx.moveTo(0, chairY); ctx.lineTo(W, chairY); ctx.stroke();
      ctx.setLineDash([]);
      ctx.font='16px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.fillText('Target: hips down to this line (â‰ˆ 90Â°)', 16, Math.max(22, chairY-8));

      // angle badges
      badge(`${Math.round(kneeAngle)}Â° knee`, pKnee.x + 14, pKnee.y - 12);
      badge(`${Math.round(ankleAngle)}Â° ankle`, pAnk.x + 14, pAnk.y - 12);

      // side progress bar 180â†’90
      const barH=H*0.6, barW=10, barX=W-28, barY=(H-barH)/2;
      ctx.fillStyle='rgba(255,255,255,.2)'; ctx.fillRect(barX,barY,barW,barH);
      const y90 = barY + ((180-90)/90)*barH;
      ctx.fillStyle='#fff'; ctx.fillRect(barX-6,y90-2,barW+12,4);
      const kClamp = Math.max(90, Math.min(180, kneeAngle));
      const yNow = barY + ((180 - kClamp)/90)*barH;
      ctx.fillStyle='#00ffc8'; ctx.fillRect(barX-2,yNow-3,barW+4,6);

      // hip vs line cue
      ctx.beginPath(); ctx.moveTo(pHip.x,pHip.y); ctx.lineTo(pHip.x, chairY);
      ctx.strokeStyle = (pHip.y - chairY) > 6 ? '#ff7676' : '#00ffc8'; ctx.lineWidth=3; ctx.stroke();

      // coaching
      let msg='', color='#fff';
      if (kneeAngle >= K_STAND) { msg='Start: go down slowly'; color='#fff'; }
      else if (kneeAngle > 94) { msg='Lowerâ€¦ aim for 90Â°'; color='#ffeb3b'; }
      else if (kneeAngle >= 86) { msg='Perfect 90Â° â€” hold briefly'; color='#00ffc8'; }
      else { msg='Too deep â€” rise a bit'; color='#ff7676'; }
      ctx.font='600 28px system-ui,-apple-system,Segoe UI,Roboto';
      ctx.textAlign='center';
      ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(W/2-260, 24, 520, 46);
      ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=2; ctx.strokeRect(W/2-260,24,520,46);
      ctx.fillStyle=color; ctx.fillText(msg, W/2, 56);

      updateReps(kneeAngle);
    } else {
      noLandmarkFrames++;
      if (noLandmarkFrames > 15) {
        ctx.font='600 20px system-ui,-apple-system,Segoe UI,Roboto';
        ctx.fillStyle='rgba(255,255,255,.9)';
        ctx.textAlign='center';
        ctx.fillText('Step back so hips/knees/ankles/feet are in frame', canvas.width/2, 40);
      }
    }

    requestAnimationFrame(tick);
  }

  if (video.readyState >= 2) tick();
  else video.addEventListener('loadeddata', tick, { once:true });
})();
</script>
</body>
</html>
